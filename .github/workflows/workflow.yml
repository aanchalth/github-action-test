name: "JFrog CLI npm Publish OIDC"
on: push

permissions:
  id-token: write  # Required to request the JWT
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        id: setup-jfrog
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: https://migration3.jfrog.io 
        with:
          oidc-provider-name: git-test 
          oidc-audience: my-aud

      - name: Fetch and Debug OIDC Token
        # This step manually retrieves the same token the JFrog CLI uses
        run: |
          # 1. Request the token from GitHub's internal IdP
          # The 'actions/oidc-client' User-Agent is required
          RAW_TOKEN=$(curl -sLS -H "User-Agent: actions/oidc-client" \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=jfrog-github" \
            | jq -r .value)
          
          # 2. Decode the token payload to see the claims (repo, branch, etc.)
          # Note: GitHub will mask the raw token as *** in logs
          echo "Decoding OIDC Token Claims:"
          echo "$RAW_TOKEN" | cut -d "." -f 2 | base64 -d | jq .
        
      - name: npm Publish to Artifactory
        working-directory: ./npm-test
        run: |
          jf npm-config --repo-deploy=github-npm --repo-resolve=github-npm
          jf npm install
          jf npm publish --build-name=npm-build --build-number=${{ github.run_id }}
          jf rt bce npm-build ${{ github.run_id }}
          jf rt bag npm-build ${{ github.run_id }}
          jf rt bp npm-build ${{ github.run_id }}
